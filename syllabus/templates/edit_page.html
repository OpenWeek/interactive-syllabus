<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="/static/js/jquery-3.1.1.min.js"></script>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/static/css/codemirror.css">
    <script src="/static/js/codemirror.js"></script>
    <script src="/static/js/codemirror-overlay.js"></script>
    <script src="/static/js/codemirror-clike-style.js"></script>
    <script src="/static/js/codemirror-yaml.js"></script>
    <script src="/static/js/codemirror-rst.js"></script>
    <script type="text/javascript" src="/static/js/rst-form.js"></script>
    <script type="text/javascript" src="/static/js/jquery-shuffle.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui.min.js"></script>
    <style>
        h1 {
            text-align:center;
        }
        .CodeMirror {
            border: 1px solid #eee;
        }
        .live_editor {
            display: flex;
        }
    </style>
</head>
<body>
        <h1 id="title">Edition of {{ content.path if content != TOC.index else "Syllabus index" }}</h1>
        <div id="editor" style="margin: 20px" data-language="rst">
            <form method="post">

                <div class="modal-body rowr">
                    <div class="col-md-6">
                        <div id="editor_menu_left" style="height: 50px">
                            <button type="submit" class="btn btn-primary">Submit</button><br /><br />
                        </div>
                        <textarea id="content" name="new_content">{{ content_data }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <div id="editor_menu_left" style="height: 50px">

                        </div>
                        <div id="preview"></div>
                    </div>
                </div>

            </form>
        </div>

<script>
    let header_size = $("#title").height();
    let editor_menu_size_left = $("#editor_menu_left").height();
    let windows_size = $(window).height();

    let area_content = $('#content').get(0);
    let area_preview = $("#preview");
    content_cm = CodeMirror.fromTextArea(area_content, {
        lineNumbers: true,
        matchBrackets: true,
        mode: "rst",
        viewportMargin: Infinity
    });

    content_cm.setSize("100%", windows_size-header_size-editor_menu_size_left-75);
    area_preview.height(windows_size-header_size-editor_menu_size_left-75);

    function refresh_preview() {
        $.ajax({
            type: 'POST',
            url: '/syllabus/refresh',
            data: {content:content_cm.getValue()},
            dataType: 'html',
            timeout: 3000,
            success: function(code_html) {
                $(code_html).replaceAll("#preview");
                $("#preview").height(windows_size-header_size-editor_menu_size_left-75);
            },
            error: function() {
                alert('Error while refreshing the .rst preview');
            }
        });
    }

    content_cm.on("change", function() {
        refresh_preview()
    });

    refresh_preview();

    $(window).resize(function() {
        let header_size = $("#title").height();
        let editor_menu_size_left = $("#editor_menu_left").height();
        let windows_size = $(window).height();
        content_cm.setSize("100%", windows_size-header_size-editor_menu_size_left-75);
        $("#preview").height(windows_size-header_size-editor_menu_size_left-75);
    });

    var userScroll1 = true;
    var userScroll2 = true;
    var timer;

    $('.CodeMirror-scroll').scroll(function() {
        if(userScroll2) {
            userScroll1 = false;
            clearTimeout(timer);
            $("#preview").scrollTop($('.CodeMirror-scroll').scrollTop());
            timer = setTimeout(function() {
                userScroll1 = true;
            }, 100);
        }
    });

</script>
</body>
</html>